---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/map.css';
import mapScriptUrl from '@scripts/map.js?url';
import mainScriptUrl from '@scripts/main.js?url';
---
 
<Layout 
  title="Bản đồ số du lịch - Khu du lịch quốc gia Núi Bà Đen"
  description="Bản đồ số Khu du lịch quốc gia Núi Bà Đen - Tìm kiếm địa điểm, chỉ đường, thông tin chi tiết và thuyết minh audio."
>
  <Header currentPage="map" pageTitle="Bản đồ số du lịch Núi Bà Đen" />

  <main class="flex-grow overflow-hidden">
    <div class="map-container">
      <div class="top-bar bg-white border-b border-gray-200 p-2 sm:p-3 md:p-4 shadow-sm">
        <div class="search-bar relative flex items-center bg-gray-100 rounded-full px-3 sm:px-4 py-1.5 sm:py-2 mb-2 sm:mb-3">
          <input type="text" placeholder="Tìm kiếm địa điểm..." id="search-input-main" class="flex-grow border-none outline-none bg-transparent text-sm sm:text-base text-gray-700 placeholder-gray-500">
          <span class="icon search-icon-main text-gray-400 pl-2 cursor-pointer"><i class="fas fa-search"></i></span>
          <button type="button" id="directions-icon-search" class="icon text-primary-500 hover:text-primary-600 pl-2 hidden md:inline-flex items-center justify-center" aria-label="Tìm đường">
            <i class="fas fa-route"></i>
          </button>
          <div id="search-results-dropdown" class="absolute left-0 right-0 top-full w-full sm:w-[400px] md:w-[500px] mx-auto sm:mx-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-[1002] overflow-y-auto max-h-60" style="display: none;"></div>
        </div>

        <div class="filter-categories-wrapper relative flex items-center">
          <button id="filter-scroll-left" class="hidden md:flex absolute left-0 z-10 h-full items-center justify-center px-2 bg-white/80 hover:bg-white rounded-l-lg shadow transition-all" style="top:0; bottom:0;">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="filter-categories flex gap-1.5 sm:gap-2 overflow-x-auto pb-1 w-full" style="scroll-behavior: smooth;"></div>
          <button id="filter-scroll-right" class="hidden md:flex absolute right-0 z-10 h-full items-center justify-center px-2 bg-white/80 hover:bg-white rounded-r-lg shadow transition-all" style="top:0; bottom:0;">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      
      <div id="route-inputs" class="p-2 sm:p-3 bg-white border-b border-gray-200 shadow-md" style="display: none;">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
          <div class="relative">
            <input type="text" id="start-input" placeholder="Điểm bắt đầu" class="w-full p-2 border border-gray-300 rounded-md text-sm bg-white text-gray-700 placeholder-gray-400">
            <div id="start-suggestions" class="suggestions-box absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-[25] overflow-y-auto max-h-40" style="display: none;"></div>
          </div>
          <div class="relative">
            <input type="text" id="end-input" placeholder="Điểm kết thúc" class="w-full p-2 border border-gray-300 rounded-md text-sm bg-white text-gray-700 placeholder-gray-400">
            <div id="end-suggestions" class="suggestions-box absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-[25] overflow-y-auto max-h-40" style="display: none;"></div>
          </div>
        </div>
        <div class="flex items-center justify-between mt-2">
          <button id="find-route-button" class="flex-1 bg-primary-500 hover:bg-primary-600 text-white font-semibold py-2 px-4 rounded-md text-sm transition duration-150 flex items-center justify-center">
            <i class="fas fa-directions mr-1.5"></i> Tìm đường
          </button>
          <button id="close-route-inputs-btn" aria-label="Đóng tìm đường" class="ml-2 w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 bg-white text-gray-500 hover:bg-gray-100 hover:text-red-500 transition-all z-10">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="map-area">
        <div id="map"></div>

        
        
        <!-- POI Panel Backdrop -->
        <div id="poi-panel-backdrop" class="poi-panel-backdrop hidden"></div>
        
        <div id="info-panel" class="poi-panel hidden" style="display: none;">
          <div class="poi-panel-content">
            <!-- Content will be dynamically inserted by JavaScript -->
          </div>
        </div>

        <div id="route-instructions-panel" class="route-instructions-panel hidden" style="display: none;">
          <div id="route-instructions-content"></div>
        </div>
      </div>

      <div class="floating-action-buttons md:hidden absolute bottom-4 right-4 z-[1000] flex flex-col gap-3">
        <button id="fab-search" class="fab bg-white hover:bg-gray-100 text-gray-700" title="Tìm kiếm">
          <i class="fas fa-search"></i>
        </button>
        <button id="fab-directions" class="fab bg-white hover:bg-gray-100 text-green-600" title="Tìm đường">
          <i class="fas fa-route"></i>
        </button>
        <button id="fab-locate" class="fab bg-white hover:bg-gray-100 text-blue-600" title="Định vị của tôi">
          <i class="fas fa-location-arrow"></i>
        </button>
        <button id="fab-tutorial" class="fab bg-white hover:bg-gray-100 text-yellow-500" title="Hướng dẫn sử dụng">
          <i class="fas fa-question-circle"></i>
        </button>
      </div>
    </div>
  </main>

  

  <!-- Audio player for POI descriptions -->
  <audio id="poi-audio-player" style="display:none;"></audio>

  <!-- Popup backdrop -->
  <div id="popup-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-[1040]" style="display: none;"></div>

  <!-- Tutorial popup -->
  <div id="tutorial-popup" class="custom-popup fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-4 sm:p-6 rounded-lg shadow-xl z-[1050] w-[90vw] max-w-md max-h-[85vh] overflow-y-auto" style="display: none;">
    <button id="tutorial-close-btn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 p-2" aria-label="Đóng hướng dẫn">
      <i class="fas fa-times text-lg"></i>
    </button>
    <h4 id="tutorial-title" class="text-md sm:text-lg font-semibold mb-3 text-primary-600 text-center">Hướng dẫn sử dụng bản đồ</h4>
    <div class="tutorial-content space-y-2.5 text-xs sm:text-sm text-gray-700">
      <p id="tutorial-text-search" class="flex items-center"><span class="icon-example mr-2 bg-gray-200 p-1 rounded"><i class="fas fa-search text-primary-500"></i></span> Sử dụng ô tìm kiếm để tìm địa điểm.</p>
      <p id="tutorial-text-directions" class="flex items-center"><span class="icon-example mr-2 bg-gray-200 p-1 rounded"><i class="fas fa-route text-primary-500"></i></span> Nhấn biểu tượng chỉ đường để nhập điểm và tìm lộ trình.</p>
      <p id="tutorial-text-location" class="flex items-center"><span class="icon-example mr-2 bg-gray-200 p-1 rounded"><i class="fas fa-location-arrow text-primary-500"></i></span> Nhấn để xem vị trí hiện tại của bạn.</p>
      <p id="tutorial-text-audio" class="flex items-center"><span class="icon-example mr-2 bg-gray-200 p-1 rounded"><i class="fas fa-play text-yellow-500"></i></span> Nhấn nút "Thuyết minh" (nếu có) để nghe giới thiệu.</p>
    </div>
    <div class="language-switcher mt-4 pt-3 border-t border-gray-200 text-center">
      <span id="language-switcher-label" class="text-xs text-gray-600 mr-2">Ngôn ngữ:</span>
      <button id="lang-vi" class="lang-btn text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-100">Tiếng Việt</button>
      <button id="lang-en" class="lang-btn text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-100">English</button>
    </div>
  </div>

  <!-- Descent choice popup -->
  <div id="descent-choice-popup" class="custom-popup fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-4 sm:p-6 rounded-lg shadow-xl z-[1050] w-[90vw] max-w-sm" style="display: none;">
    <h4 id="descent-choice-title" class="text-md sm:text-lg font-semibold mb-3 text-primary-600 text-center">Chọn phương tiện xuống núi</h4>
    <div class="flex flex-col gap-3">
      <button id="choice-cable-car" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md text-center transition duration-150 text-sm flex items-center justify-center gap-2">
        <i class="fas fa-tram"></i> <span class="descent-choice-cable-text">Cáp treo</span>
      </button>
      <button id="choice-alpine-coaster" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md text-center transition duration-150 text-sm flex items-center justify-center gap-2">
        <i class="fas fa-sleigh"></i> <span class="descent-choice-coaster-text">Máng trượt</span>
      </button>
    </div>
  </div>

  <!-- Language Popup -->
  <div id="languagePopup" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Chọn ngôn ngữ</h3>
        <button onclick="toggleLanguageMenu()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="language-options space-y-2">
        <button onclick="translatePage('vi')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/vn.png" alt="VN" class="inline w-6 h-4 rounded-sm"></span>
          <span>Tiếng Việt</span>
        </button>
        <button onclick="translatePage('en')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/gb.png" alt="GB" class="inline w-6 h-4 rounded-sm"></span>
          <span>English</span>
        </button>
        <button onclick="translatePage('fr')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/fr.png" alt="FR" class="inline w-6 h-4 rounded-sm"></span>
          <span>Français</span>
        </button>
        <button onclick="translatePage('de')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/de.png" alt="DE" class="inline w-6 h-4 rounded-sm"></span>
          <span>Deutsch</span>
        </button>
        <button onclick="translatePage('ja')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/jp.png" alt="JP" class="inline w-6 h-4 rounded-sm"></span>
          <span>日本語</span>
        </button>
        <button onclick="translatePage('ko')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/kr.png" alt="KR" class="inline w-6 h-4 rounded-sm"></span>
          <span>한국어</span>
        </button>
        <button onclick="translatePage('zh-CN')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/cn.png" alt="CN" class="inline w-6 h-4 rounded-sm"></span>
          <span>中文</span>
        </button>
        <button onclick="translatePage('ru')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center">
          <span class="mr-2"><img src="https://flagcdn.com/24x18/ru.png" alt="RU" class="inline w-6 h-4 rounded-sm"></span>
          <span>Русский</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Map-specific CSS -->
  <!-- CSS is imported in the frontmatter -->

  <!-- Leaflet CSS - Critical for map functionality -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <!-- Leaflet plugins - Load asynchronously -->
  <link rel="preload" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"></noscript>
  <link rel="preload" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"></noscript>

  <!-- Load Leaflet and dependencies -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Load Leaflet plugins synchronously to ensure they're available -->
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>

  <!-- Load main scripts after plugins are loaded (use Vite-resolved URLs) -->
  <script type="module" src={mapScriptUrl}></script>
  <script type="module" src={mainScriptUrl}></script>
  
  <script is:inline>
    // Toggle top-bar visibility
    function toggleTopBar() {
        const topBar = document.querySelector('.top-bar');
        const routeInputs = document.getElementById('route-inputs');
        
        if (topBar.classList.contains('hidden')) {
            topBar.classList.remove('hidden');
            if (routeInputs) routeInputs.style.display = 'none';
        } else {
            topBar.classList.add('hidden');
        }
    }

    // Add event listeners
    const mapLayersDesktopBtn = document.getElementById('map-layers-desktop');
    if (mapLayersDesktopBtn) {
        mapLayersDesktopBtn.addEventListener('click', function() {
            const searchInput = document.getElementById('search-input-main');
            const topBar = document.querySelector('.top-bar');
            const routeInputsContainer = document.getElementById('route-inputs');
            if (topBar) {
                topBar.classList.remove('hidden');
                topBar.style.display = '';
            }
            if (routeInputsContainer) {
                routeInputsContainer.style.display = 'none';
            }
            if (searchInput) {
                searchInput.focus();
            }
        });
    }

    // Đóng route instructions panel khi click ra ngoài
    document.addEventListener('mousedown', function(event) {
        const panel = document.getElementById('route-instructions-panel');
        if (panel && panel.style.display !== 'none' && !panel.contains(event.target)) {
            panel.style.display = 'none';
        }
    });

    // Nút cuộn filter-categories
    const filterCategories = document.querySelector('.filter-categories');
    const btnLeft = document.getElementById('filter-scroll-left');
    const btnRight = document.getElementById('filter-scroll-right');
    function updateArrowButtons() {
        if (!filterCategories) return;
        // Luôn hiển thị nút phải nếu có thể cuộn ngang
        const canScroll = filterCategories.scrollWidth > filterCategories.clientWidth + 5;
        btnLeft.style.display = filterCategories.scrollLeft > 0 ? 'flex' : 'none';
        btnRight.style.display = canScroll ? 'flex' : 'none';
    }
    if (btnLeft && btnRight && filterCategories) {
        btnLeft.addEventListener('click', () => {
            filterCategories.scrollBy({ left: -150, behavior: 'smooth' });
        });
        btnRight.addEventListener('click', () => {
            filterCategories.scrollBy({ left: 150, behavior: 'smooth' });
        });
        filterCategories.addEventListener('scroll', updateArrowButtons);
        window.addEventListener('resize', updateArrowButtons);
        setTimeout(updateArrowButtons, 500);
    }
  </script>
</Layout>