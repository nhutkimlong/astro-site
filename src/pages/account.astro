---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Hồ sơ của tôi">
  <Header currentPage="account" />
  <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <h1 class="text-2xl font-bold text-slate-800 mb-4">Hồ sơ của tôi</h1>
      <div id="status" class="hidden mb-4 p-3 rounded text-sm"></div>

      <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Họ tên</label>
          <input id="nameInput" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
          <input id="emailInput" type="email" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-100" readonly>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Số điện thoại</label>
          <input id="phoneInput" type="tel" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Ngày sinh</label>
          <input id="dobInput" type="date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">CCCD</label>
          <input id="idCardInput" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Địa chỉ</label>
          <input id="addressInput" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="md:col-span-2 flex justify-end gap-3 pt-2">
          <button type="button" id="saveBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Lưu thay đổi</button>
        </div>
      </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-xl font-semibold text-slate-800 mb-4">Đổi mật khẩu</h2>
        <div class="grid grid-cols-1 gap-3">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Mật khẩu hiện tại</label>
            <input id="currentPasswordInput" type="password" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Mật khẩu mới</label>
            <input id="passwordInput" type="password" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div class="flex justify-end">
            <button type="button" id="changePwdBtn" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800">Cập nhật mật khẩu</button>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-xl font-semibold text-slate-800 mb-4">Thống kê leo núi</h2>
        <div class="grid grid-cols-1 gap-2 text-slate-700 text-sm">
          <div class="p-3 rounded bg-emerald-50 border border-emerald-200">
            <div class="text-xs">Số lần đăng ký leo núi thành công</div>
            <div id="climbCount" class="text-2xl font-semibold">0</div>
          </div>
          <div class="p-3 rounded bg-slate-50 border border-slate-200">
            <div class="text-xs">Lần gần nhất</div>
            <div id="lastClimb" class="font-medium">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    function showStatus(msg, ok) {
      const s = document.getElementById('status');
      if (!s) return;
      s.textContent = msg;
      s.className = 'mb-4 p-3 rounded text-sm ' + (ok ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200');
      s.classList.remove('hidden');
      setTimeout(() => s.classList.add('hidden'), 2500);
    }

    async function authFetch(url, opts={}){
      const token = localStorage.getItem('authToken');
      const headers = Object.assign({}, opts.headers || {}, { 'Authorization': 'Bearer ' + token, 'Content-Type':'application/json' });
      const res = await fetch(url, Object.assign({}, opts, { headers }));
      return res;
    }

    async function loadMe(){
      try{
        const res = await authFetch('/.netlify/functions/auth', { method:'POST', body: JSON.stringify({ action:'me' }) });
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error(json.error || 'Không tải được hồ sơ');
        document.getElementById('nameInput').value = json.user.name || '';
        document.getElementById('emailInput').value = json.user.email || '';
        document.getElementById('phoneInput').value = json.user.phone || '';
        document.getElementById('dobInput').value = json.user.dob || '';
        document.getElementById('idCardInput').value = json.user.idCard || '';
        document.getElementById('addressInput').value = json.user.address || '';
        document.getElementById('climbCount').textContent = json.user.successfulClimbCount || 0;
        document.getElementById('lastClimb').textContent = json.user.lastClimbAt ? new Date(json.user.lastClimbAt).toLocaleString('vi-VN') : '-';
      }catch(err){ showStatus(err.message || 'Lỗi', false); }
    }

    async function loadStats(){ /* chỗ trống nếu sau này cần thêm thống kê khác */ }

    document.getElementById('saveBtn')?.addEventListener('click', async () => {
      try{
        const name = document.getElementById('nameInput').value.trim();
        const phone = document.getElementById('phoneInput').value.trim();
        const newPassword = '';
        const dob = document.getElementById('dobInput').value;
        const idCard = document.getElementById('idCardInput').value;
        const address = document.getElementById('addressInput').value;
        const res = await authFetch('/.netlify/functions/auth', { method:'POST', body: JSON.stringify({ action:'updateSelf', name, phone, dob, idCard, address, newPassword }) });
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error(json.error || 'Lưu thất bại');
        // update cached name
        const raw = localStorage.getItem('authUser');
        if (raw) { try { const u = JSON.parse(raw); u.name = name || u.name; localStorage.setItem('authUser', JSON.stringify(u)); } catch {} }
        showStatus('Đã lưu thay đổi', true);
      }catch(err){ showStatus(err.message || 'Lỗi', false); }
    });

    document.getElementById('changePwdBtn')?.addEventListener('click', async () => {
      try{
        const currentPassword = document.getElementById('currentPasswordInput').value;
        const newPassword = document.getElementById('passwordInput').value;
        const res = await authFetch('/.netlify/functions/auth', { method:'POST', body: JSON.stringify({ action:'updateSelf', currentPassword, newPassword }) });
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error(json.error || 'Cập nhật mật khẩu thất bại');
        showStatus('Đã cập nhật mật khẩu', true);
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('passwordInput').value = '';
      }catch(err){ showStatus(err.message || 'Lỗi', false); }
    });

    // init
    (function(){
      if (!localStorage.getItem('authToken')) { window.location.href = '/login'; return; }
      loadMe();
      loadStats();
    })();
  </script>
  <Footer />
</Layout>


